<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Adventure Game</title>
    <style>
    body { background-color: #bbb; }
    #container {
      position: relative;
      width: 512px;
      height: 512px;
    }
    #container canvas {
      position: absolute;
      left: 0px;
      top: 0px;
    }
    #container canvas#layer1 { z-index: 1; }
    #container canvas#layer2 { z-index: 2; }
    </style>
  </head>
  <body>
    <header>RPG Adventure!</header>
    <div id="container">
      <canvas id="layer1" width="512" height="512"></canvas>
      <canvas id="layer2" width="512" height="512"></canvas>
    </div>
    <footer>
      Press arrow keys to move.<br/>
      Game art courtesy of <a href="http://untamed.wild-refuge.net/rpgxp.php">Sithjester</a>.
    </footer>
    
    <script src="./utils.js"></script>
    <script src="./TileMap.js"></script>
    <script src="./TileSheet.js"></script>
    <script src="./levels/meadow.js"></script>
    <script src="./Renderer.js"></script>
    <script src="./assets/tileset/village_data.js"></script>
    <script src="./Sprite.js"></script>
    <script src="./assets/character/character_data.js"></script>
    <script>
   "use strict";
    window.onload = function () {
      var layer1 = document.getElementById('layer1'),
          ctx1 = layer1.getContext('2d'),
          layer2 = document.getElementById('layer2'),
          ctx2 = layer2.getContext('2d');
          
      var sprite1 = new Sprite('./assets/character/darion.png', character_data.DEFAULT);
      sprite1.x = 100;
      sprite1.y = 220;
      
      var sprite2 = new Sprite('./assets/character/randomgirl.png', character_data.DEFAULT);
      sprite2.x = 220;
      sprite2.y = 120;
      
      var tilesheet = new TileSheet('./assets/tileset/village.png', village_data, 32, 32);
      var tilemap = new TileMap(meadow, tilesheet);

      var renderer = new Renderer();
      renderer.setTileMap(tilemap);
      //renderer.debug = true;

      renderer.add(sprite1);
      renderer.add(sprite2);
      
      /* Draw background on layer1 canvas ONCE on initial load.
       */
      tilesheet.image.addEventListener('load', function () {
        renderer.repaintBackground(ctx1);
      });
      
      /* Main animation loop:
       * Re-draw objects on layer2 canvas EACH frame.
       */
      (function drawFrame () {
        window.requestAnimationFrame(drawFrame, layer2);
        ctx2.clearRect(0, 0, layer2.width, layer2.height);
        renderer.draw(ctx2);
      }());

      
      /*
       * KEYBOARD EVENTS
       */
      window.addEventListener('keydown', function (event) {
        switch (event.keyCode) {
        case 37: //left
          sprite1.play(1); //column
          sprite1.vx = -2;
          break;
        case 38: //up
          sprite1.play(3);
          sprite1.vy = -2;
          break;
        case 39: //right
          sprite1.play(2);
          sprite1.vx = 2;
          break;
        case 40: //down
          sprite1.play(0);
          sprite1.vy = 2;
          break;
        }
      }, false);

      window.addEventListener('keyup', function () {
        sprite1.stop();
        sprite1.vx = 0;
        sprite1.vy = 0;
      }, false);
    };
    </script>
  </body>
</html>
